LINUX_DIR	=	@LINUX_BUILD@
OPEN_MX_DIR	=	@abs_builddir@

.PHONY: all installonly install clean distclean wc

# Cannot avoid symlinking source files here and using O=builddir M=srcdir
# since configure would have to generate Kbuild and omx_checks.h in srcdir
# instead of builddir

all:
	@if test "@srcdir@" != "@builddir@" ; then \
		echo Linking kernel module source files to local directory ; \
		for file in $(wildcard @srcdir@/*.[ch]) ; do test -e $$(basename $$file) || ln -sf $$file ; done ; \
	fi
	@echo Running compile-time assertions
	+make -C $(LINUX_DIR) M=$(OPEN_MX_DIR) omx__assertions.o
	@echo Building kernel module
	+make -C $(LINUX_DIR) M=$(OPEN_MX_DIR)

installonly:
	@echo "Installing kernel module for kernel $(LINUX_DIR)"
	+make -C $(LINUX_DIR) M=$(OPEN_MX_DIR) modules_install

install: all installonly

clean:
	@echo Cleaning kernel module build
	+make -C $(LINUX_DIR) M=$(OPEN_MX_DIR) clean
	@if test "@srcdir@" != "@builddir@" ; then \
		echo Removing links to kernel module source files in local directory ; \
		for file in $(wildcard @srcdir@/*.[ch]) ; do rm -f $$(basename $$file) ; done ; \
	fi

# nothing special needed for distclean here
distclean: clean

wc:
	wc -cl *.[ch]
