exec_prefix	=	@exec_prefix@
prefix  =       @prefix@
libdir	=	@libdir@

include @abs_top_srcdir@/common.mk

KCC	=	@KCC@
MKDIR_P	=	@MKDIR_P@
LN_S	=	@LN_S@
INSTALL	=	@INSTALL@

ifneq ($(KCC),)
  KBUILD_VARS	+=	CC="$(KCC)"
endif

LINUX_DIR	=	@LINUX_BUILD@
OPEN_MX_DIR	=	@abs_builddir@
INSTALL_MOD_PATH	=	$(libdir)/modules/@LINUX_RELEASE@
MODULE_OBJS	=	open-mx.ko

.PHONY: all installonly install clean distclean wc

# Cannot avoid symlinking source files here and using O=builddir M=srcdir
# since configure would have to generate Kbuild and omx_checks.h in srcdir
# instead of builddir

all: links
	$(CMDECHO) "  MAKE    DRIVER"
	$(CMDPREFIX) +$(MAKE) -C $(LINUX_DIR) M=$(OPEN_MX_DIR) $(KBUILD_VARS)

installonly:
	$(CMDECHO) "  MKDIR   $(DESTDIR)$(INSTALL_MOD_PATH)"
	$(CMDPREFIX) if test ! -d $(DESTDIR)$(INSTALL_MOD_PATH); then \
		$(MKDIR_P) -p $(DESTDIR)$(INSTALL_MOD_PATH) ; \
	fi

	$(CMDECHO) "  INSTALL DRIVER"
	$(CMDPREFIX) $(INSTALL) -m 0644 $(MODULE_OBJS) $(DESTDIR)$(INSTALL_MOD_PATH)/

install: all installonly

clean:
	$(CMDECHO) "  CLEAN   DRIVER"
	$(CMDPREFIX) +$(MAKE) -C $(LINUX_DIR) M=$(OPEN_MX_DIR) $(KBUILD_VARS) clean

distclean: clean clean-links

links:
	$(CMDECHO) "  PREPARE DRIVER SOURCES"
	$(CMDPREFIX) if test "@srcdir@" != "@builddir@" ; then \
		for file in $(wildcard @srcdir@/*.[ch]) ; do test -e $$(basename $$file) || $(LN_S) $$file ; done ; \
	fi

clean-links:
	$(CMDECHO) "  CLEAN   DRIVER SOURCES"
	$(CMDPREFIX) if test "@srcdir@" != "@builddir@" ; then \
		for file in $(wildcard @srcdir@/*.[ch]) ; do $(RM) $$(basename $$file) ; done ; \
	fi

wc:
	wc -cl *.[ch]
