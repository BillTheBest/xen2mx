exec_prefix	=	@exec_prefix@
libdir	=	@libdir@
prefix	=	@prefix@

CC	=	gcc

CPPFLAGS	+=	-imacros @top_builddir@/common/omx_config.h
CPPFLAGS	+=	-I@top_srcdir@/common

CFLAGS	+=	-Wall
ifeq (@OMX_DEBUG@,1)
CFLAGS	+=	-g -O0
else
CFLAGS	+=	-O2
endif

STATIC_CFLAGS	+=	
DYNAMIC_CFLAGS	+=	-fpic

SRCS	=	$(wildcard @srcdir@/*.c)

STATIC_OBJS	=	$(patsubst @srcdir@/%.c,%.o,$(SRCS))
STATIC_LIB_OBJS	=	$(filter-out omx__assertions.o,$(STATIC_OBJS))
STATIC_LIB	=	@top_builddir@/@OPEN_MX_LIB_STATIC@

DYNAMIC_OBJS	=	$(subst .o,.lo,$(STATIC_OBJS))
DYNAMIC_LIB_OBJS	=	$(subst .o,.lo,$(STATIC_LIB_OBJS))
DYNAMIC_LIB	=	@top_builddir@/@OPEN_MX_LIB_DYNAMIC@

.PHONY: all installonly install assertions depend clean distclean

# build assertions first, then the actual lib
all: assertions $(STATIC_LIB) $(DYNAMIC_LIB)

###############
# dependencies

DEPS	=	$(patsubst @srcdir@/%.c,%.d,$(SRCS))
DEPSRCDIR	=	@srcdir@
# make sure the dependency contains both .lo and .o targets
BUILD_O_AND_LO_OBJECTS	=	1

include @top_srcdir@/depend.mk

########
# build

$(STATIC_LIB): $(STATIC_LIB_OBJS)
	ar cr $@ $^

$(DYNAMIC_LIB): $(DYNAMIC_LIB_OBJS)
	gcc --shared -o $@ $^

assertions: omx__assertions.o

# build and create dependency file

$(STATIC_OBJS): %.o: @srcdir@/%.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $(STATIC_CFLAGS) $(BUILDDEPFLAGS) -MT $(subst .o,.lo,$@) $< -o $@

$(DYNAMIC_OBJS): %.lo: @srcdir@/%.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $(DYNAMIC_CFLAGS) $(BUILDDEPFLAGS) -MT $(subst .lo,.o,$@) $< -o $@

##########
# install

installonly:
	@echo "Installing libs to $(DESTDIR)$(libdir)/"
	@if test ! -d $(DESTDIR)$(libdir); then \
		echo "Directory didn't exist, creating it" ; \
		mkdir -p $(DESTDIR)$(libdir) ; \
	fi
	install -m 0644 $(STATIC_LIB) $(DYNAMIC_LIB) $(DESTDIR)$(libdir)/

install: all installonly

########
# clean

clean:
	$(RM) $(STATIC_LIB) $(STATIC_LIB_OBJS) $(DYNAMIC_LIB) $(DYNAMIC_LIB_OBJS)

distclean: clean
	$(RM) $(DEPS)
