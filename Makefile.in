exec_prefix	=	@exec_prefix@
prefix	=	@prefix@
includedir	=	@includedir@
srcdir	=	@srcdir@

.PHONY: all install clean distcleqn
.PHONY: driver driver-installonly driver-install driver-clean driver-distclean
.PHONY: lib lib-installonly lib-install lib-clean lib-distclean
.PHONY: tools tools-installonly tools-install tools-clean tools-distclean
.PHONY: tests tests-installonly tests-install tests-clean tests-distclean

all: driver lib tools tests

other-installonly:
	@echo "Installing to $(DESTDIR)$(prefix)"
	@if test ! -d $(DESTDIR)$(prefix); then \
		echo "'$(DESTDIR)$(prefix) didn't exist, creating it" ; \
		mkdir -p $(DESTDIR)$(prefix) ; \
	fi
	@if test ! -d $(DESTDIR)$(includedir); then \
		echo "$(DESTDIR)$(includedir) didn't exist, creating it" ; \
		mkdir -p $(DESTDIR)$(includedir) ; \
	fi
	install -m 0644 $(srcdir)/common/openmx.h $(DESTDIR)$(includedir)

installonly: driver-installonly lib-installonly tools-installonly tests-installonly other-installonly

install: driver-install lib-install tools-install tests-install other-installonly

clean: driver-clean lib-clean tools-clean tests-clean

distclean: driver-distclean lib-distclean tools-distclean tests-distclean

driver driver-installonly driver-install driver-clean driver-distclean:
	$(MAKE) -C driver/linux $(shell echo $@ | cut -s -d- -f2)

lib lib-installonly lib-install lib-clean lib-distclean:
	$(MAKE) -C libopenmx $(shell echo $@ | cut -s -d- -f2)

# the lib is required before linking the tools or tests
tools tests: lib

tools tools-installonly tools-install tools-clean tools-distclean:
	$(MAKE) -C tools $(shell echo $@ | cut -s -d- -f2)

tests tests-installonly tests-install tests-clean tests-distclean:
	$(MAKE) -C tests bindir=$(bindir)/tests $(shell echo $@ | cut -s -d- -f2)

wc:
	wc -cl \
		driver/linux/*.[ch] \
		common/*.h \
		libopenmx/*.[ch] \
		tools/*.c \
		tests/*.c

dist:
	olddir=$$(basename $$PWD) && newdir=mpoe-svn.$$(date +%Y%m%d.%H%M%S) && cd .. \
	 && cp -a $$olddir $$newdir && find $$newdir -type d | grep '\.svn$$' | xargs rm -rf \; \
	 && cd $$newdir && autoreconf -f && rm -rf autom4te.cache/ && cd .. \
	 && tar cfz $${newdir}.tar.gz $$newdir \
	 && rm -rf $$newdir \
	 && cd $$olddir
