bindir = @bindir@
sbindir = @sbindir@
exec_prefix = @exec_prefix@
prefix = @prefix@

SRCS	=	$(wildcard @srcdir@/*.c)
OBJS	=	$(patsubst @srcdir@/%.c,%.o,$(SRCS))
TOOLS	=	$(subst .o,,$(OBJS))

CC	=	@CC@
LD	=	@CC@ #FIXME
MKDIR_P	=	@MKDIR_P@
SED	=	@SED@
INSTALL	=	@INSTALL@

CPPFLAGS	+=	-imacros @top_builddir@/common/omx_config.h
CPPFLAGS	+=	-I@top_srcdir@/common -I@top_srcdir@/libopen-mx
CFLAGS	+=	-Wall
CFLAGS	+=	-g -O2

LIB	=	@top_builddir@/@OPEN_MX_LIB_STATIC@

.PHONY: all installonly install clean distclean

all: $(TOOLS)

###############
# dependencies

DEPS	=	$(subst .o,.d,$(OBJS))
DEPSRCDIR	=	@srcdir@
include @top_srcdir@/depend.mk

########
# build

$(TOOLS): %: %.o $(LIB)
	$(LD) $^ -o $@

# build and create dependency file
$(OBJS): %.o: @srcdir@/%.c
	$(CC) -c $(CPPFLAGS) $(CFLAGS) $(BUILDDEPFLAGS) $< -o $@

##########
# install

installonly:
	@echo "Installing tools to $(DESTDIR)$(bindir)/"
	@if test ! -d $(DESTDIR)$(bindir); then \
		echo "'$(DESTDIR)$(bindir)' didn't exist, creating it" ; \
		$(MKDIR_P) $(DESTDIR)$(bindir) ; \
	fi
	$(INSTALL) -m 0755 $(TOOLS) $(DESTDIR)$(bindir)/
	
	@echo "Installing init script to $(DESTDIR)$(sbindir)/"
	@if test ! -d $(DESTDIR)$(sbindir); then \
		echo "'$(DESTDIR)$(sbindir)' didn't exist, creating it" ; \
		$(MKDIR_P) $(DESTDIR)$(sbindir) ; \
	fi
	$(SED)	-e 's£@omx_install_prefix@£$(prefix)£' \
		-e 's£@omx_device_name@£@DEVICE_NAME@£' \
		-e 's£@omx_device_group@£@DEVICE_GROUP@£' \
		-e 's£@omx_device_mode@£@DEVICE_MODE@£' \
		< @srcdir@/omx_init.in > omx_init
	$(INSTALL) -m 0755 omx_init $(DESTDIR)$(sbindir)/

install: all installonly

########
# clean

clean:
	$(RM) $(TOOLS) $(OBJS)

distclean: clean
	$(RM) $(DEPS)
